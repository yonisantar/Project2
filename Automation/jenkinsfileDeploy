pipeline{
    agent any
    environment {
        TERRAFORM_FOLDER_NAME= 'Terraform'
        REPO_NAME = 'devops-personal-project'
        APP_REPO = "https://github.com/devopsPRO27/${REPO_NAME}.git"        
        APP_DIRECTORY = "api"
        FOLDER_NAME= ${REPO_NAME}/${APP_DIRECTORY}
        CONTAINER_NAME = 'api-app'
        EXTERNAL_APP_PORT = '5000'
        INTERNAL_APP_PORT = '5000'
        TAG = 'v1.${BUILD_NUMBER}'
        ACCOUNT_NAME= 'yit1977ltld/apiproject'
        IMAGE_NAME = "${ACCOUNT_NAME}:latest"
        REGISTRY= 'hub.docker.com'
        DOCKERHUB_CREDENIALS = credentials('DockerCred')
        SHARED_WORKSPACE = '/var/jenkins_home/workspace/Deploy Enviroment'
        CREDENTIALS_ID = 'devopsSSH'
        USER_NAME = 'ubuntu'
        JSON_TEST_REQUEST = '{\"ip\": \"8.8.8.8\"}'
        OK_STATUS_CODE = '200'
        URL_TRACERT = 'traceroute'
        URL_VALIDATE_IP = 'validate_ip'
    }    
     stages {
       stage("Clone App source code"){
            steps{
                sh 'pwd'
                sh 'ls -la'
                sh "rm -rf ${REPO_NAME}"
                sh "git clone ${APP_REPO}"
                }            
            post{
               always{
                    // Delete docker file
                    sh "rm -f Dockerfile "
                }                
                success{
                    echo "App Clone Success"
                }
                failure{
                    echo "App Clone Failure"
                }
            }
        }
        stage("build image"){
            steps{
                sh 'pwd'
                sh 'ls -la'
                dir("${FOLDER_NAME}") {
                    sh "docker build -t ${IMAGE_NAME}:${TAG} -f ../../Dockerfile ."     
                    sh "docker rm -f ${CONTAINER_NAME}"                
                }
            }
            post{
                always{
                    // Delete docker file
                    sh "rm -f Dockerfile "
                }
                success{
                    echo "Api App Build Success"
                }
                failure{
                    echo "oooApi App Build Failure"
                }
            }
        }
    }
    post{
        always {
            script {
                if (env.PUBLIC_IP) {
                    echo "Server PUBLIC_IP is : ${PUBLIC_IP}"
                } else {
                    echo "PUBLIC_IP is empty"
                }
            }
        }
        success{
            echo "========pipeline executed successfully ========"
        }
        failure{
            echo "========pipeline execution failed========"
        }
    }
}
